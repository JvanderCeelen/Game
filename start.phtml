<!doctype html>

<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet/less" href="source/less/style.less">
    <script async type="text/javascript" src="source/js/less.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>
<body>
<p>
    You encounter a monster. What do you do?
</p>

<div class="healthbar hero">
    <div class="healthbar-outer">
        <div class="healthbar-inner" data-hp="">
        </div>
    </div>
</div>

<div class="healthbar monster">
    <div class="healthbar-outer">
        <div class="healthbar-inner" data-hp="">
        </div>
    </div>
</div>

<div class="console-window">

</div>

<input id="console-input" type="text" />

<script>
    players = {

        hero: {
            'name' : 'Dani',
            'hp'   : 100,
            'dodge': 5,
            'exp'  : 0,
            'crit' : 15,
        },
    }

    monsters = {

        kobold: {
            'name' : 'kobold',
            'hp'   : 50,
            'dodge': 5,
            'exp'  : 100,
            'crit' : 15,
        },

        orc: {
            'name' : 'orc',
            'hp'   : 100,
            'dodge': 5,
            'exp'  : 200,
            'crit' : 15,
        },
    }

    game = {
        heroCritChance: 15,
        monsterCritChance: 15,
        hero: players.hero,

        init: function() {
            game.attachHandlers();
            game.setPlayerInfo();
        },

        attachHandlers: function() {
            $('#console-input').on('keyup', function(event) {
                if (event.keyCode == 13) {
                    game.handleInput();
                    $(event.target).val('');
                }
            });
        },

        handleInput: function() {
            var target = $('#console-input').val();

            switch (target) {
                case (target.match(/(attack )\w/) || {}).input:
                    target = target.replace('attack ', '');
                    game.searchTarget(target);
                    break;
                case 'flee':
                    game.handleFlee();
                    break;
                case 'look':
                    game.handleLook();
                    break;
                default:
                    game.printToConsole('Excuse me?');
                    break;
            }
        },

        printToConsole: function(message) {
            $('.console-window').append('<p>' + message + '</p>');

            $('.console-window').scrollTop(
                $('.console-window p:last-child').position().top
            );
        },

        searchTarget: function(target) {
            for (var monster in monsters) {
                if (monster == target) {
                    game.handleAttack(monsters[monster]);
                }
            }

            // game.printToConsole('No-one by the name of ' + monster + ' is around!');
        },

        handleAttack: function(monster) {
            game.printToConsole('You attack the ' + monster.name + '.');
            game.setMonsterInfo(monster);
            game.attackLoop(monster);
        },

        attackLoop: function(monster) {
            game.attack(monster);

            setTimeout(function() {
                if (monster.hp > 0 && players.hero.hp > 0)
                    game.attackLoop(monster);
            }, 1000);
        },

        attack: function(monster) {
            if (game.hit(monster)) {
                var damage = game.calculateDamage(monster);
                var hitMessage = 'You <em>' + (damage['crit'] > 1 ? 'CRIT' : 'hit') + '</em> the ' + monster.name + ' for ' + damage['damage'] + ' damage.';
                game.calculateHP(damage['damage'], monster);
                monster.hp > 0 ? game.printToConsole(hitMessage) : game.handleDeath(monster);
            } else {
                var hitMessage = 'Your attack misses!'
                game.printToConsole(hitMessage);
            }

            if (game.hit(game.hero)) {
                var damage = game.calculateDamage(game.hero);
                var hitMessage = 'The ' + monster.name + ' <em>' + (damage['crit'] > 1 ? 'CRITS' : 'hits') + '</em> you for ' + damage['damage'] + ' damage.';
                game.calculateHP(damage['damage'], game.hero);
                players.hero.hp > 0 ? game.printToConsole(hitMessage) : game.handleDeath(game.hero);
            } else {
                var hitMessage = 'The monster attack misses!'
                game.printToConsole(hitMessage);
            }
        },

        hit: function(target) {
            var dodge = 0;

            if (target == game.hero) {
                dodge = game.hero.dodge;
            } else {
                dodge = target.dodge;
            }

            var number = game.generateRandomNumber();
            return number <= dodge ? false : true;
        },

        calculateDamage: function(target) {
            var multiplier = game.calculateCritMultiplier(target);
            return {
                damage: (Math.floor(Math.random() * 6) + 4) * multiplier,
                crit: multiplier,
            };
        },

        calculateCritMultiplier: function(person) {
            var random = game.generateRandomNumber();
            var critChance;

            if (person == game.hero) {
                critChance = game.heroCritChance;
            } else if (person == 'monster') {
                critChance = game.monsterCritChance;
            }

            return random <= critChance ? 2 : 1;
        },

        calculateHP: function(damage, target) {
            target.hp -= damage;

            if (target.hp < 0)
                target.hp = 0;

            if (target == game.hero) {
                var HPbar = '.hero .healthbar-inner';
            } else {
                var HPbar = '.monster .healthbar-inner';
            }

            var totalHP = $(HPbar).data('hp');

            $(HPbar).html(target.hp).width($(HPbar).width() - (damage / totalHP) * 100);
        },

        setMonsterInfo: function(monster) {
            $('.healthbar.monster').prepend(monster.name + ':');
            $('.monster .healthbar-inner').html(monster.hp).data('hp', monster.hp);;
        },

        setPlayerInfo: function() {
            $('.healthbar.hero').prepend(players.hero.name + ':');
            $('.hero .healthbar-inner').html(players.hero.hp).data('hp', players.hero.hp);;
        },

        generateRandomNumber: function(range) {
            var range = range || 100;
            return Math.floor(Math.random() * range) + 1;
        },

        handleLook: function() {
            game.printToConsole('');
        },

        handleFlee: function() {
            game.printToConsole('Oh c\'mon. REALLY?');
        },

        handleDeath:function(target) {
            if (target == game.hero) {
                game.printToConsole('<p class="result">You have died. No exp for you. Are you sure this is the right game for you?');
            } else {
                game.printToConsole('<p class="result">The ' + target.name + ' is dead. You killed it. It turned out to be a really friendly monster. Are you happy?')
            }
        }
    }

game.init();
</script>
</body>
</html>
