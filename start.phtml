<!doctype html>

<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet/less" href="source/less/style.less">
    <script async type="text/javascript" src="source/js/less.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>
<body>
<p>
    You encounter a monster. What do you do?
</p>

<div class="hero">
HP: <span>100</span>
</div>

<div class="monster">
HP: <span>50</span>
</div>

<div class="console-window">

</div>

<input id="console-input" type="text" />

<script>
    game = {
        heroHP: $('.hero span').html(),
        monsterHP: $('.monster span').html(),
        heroCritChance: 15,
        monsterCritChance: 15,

        init: function() {
            game.attachHandlers();
        },

        attachHandlers: function() {
            $('#console-input').change(game.handleInput);
        },

        handleInput: function() {
            var input = $('#console-input').val();

            switch (input) {
                case 'attack':
                    game.handleAttack();
                    break;
                case 'flee':
                    game.handleFlee();
                    break;
                default:
                    game.printToConsole('Excuse me?');
                    break;
            }
        },

        printToConsole: function(message) {
            $('.console-window').append('<p>' + message + '</p>');

            $('.console-window').scrollTop(
                $('.console-window p:last-child').position().top
            );
        },

        handleAttack: function() {
            game.printToConsole('You attack the monster.');
            game.attackLoop();
        },

        attackLoop: function() {
            game.attack();

            setTimeout(function() {
                if (game.monsterHP > 0 && game.heroHP > 0){
                    game.attackLoop();
                }
            }, 1000);
        },

        attack: function() {
            var heroDamage = game.calculateHeroDamage();
            var monsterDamage = game.calculateMonsterDamage();
            var heroHitMessage = 'You hit the monster for ' + heroDamage['damage'] + ' damage.';
            var monsterHitMessage = 'The monster hits you for ' + monsterDamage['damage'] + ' damage.';

            if (heroDamage['crit'] > 1) {
                heroHitMessage = '<p class="crit"><span>CRIT!</span> Your hit devestates the monster. ' + heroDamage['damage'] + ' damage.'
            }

            if (monsterDamage['crit'] > 1) {
                monsterHitMessage = '<p class="crit"><span>CRIT!</span> The monster hit devestates you. ' + monsterDamage['damage'] + ' damage.'
            }

            game.printToConsole(heroHitMessage);
            game.printToConsole(monsterHitMessage);

            // calculate and echo monster and hero HP
            game.calculateMonsterHP(heroDamage['damage']);
            game.calculateHeroHP(monsterDamage['damage']);
            $('.monster span').html(game.monsterHP);
            $('.hero span').html(game.heroHP);

            // Echo monster death message
            if (game.monsterHP <= 0) {
                game.printToConsole('<p class="result">The monster is dead. You killed it. It turned out to be a really friendly monster. Are you happy?')
            }

            if (game.heroHP <= 0) {
                gamme.printToConsole('<p class="result">You have died. No exp for you. Are you sure this is the right game for you?');
            }
        },

        calculateHeroDamage: function() {
            var multiplier = game.calculateCritMultiplier('hero');
            return {
                damage: (Math.floor(Math.random() * 6) + 4) * multiplier,
                crit: multiplier,
            };
        },

        calculateMonsterDamage: function() {
            var multiplier = game.calculateCritMultiplier('monster');
            return {
                damage: (Math.floor(Math.random() * 4) + 1) * multiplier,
                crit: multiplier,
            }
        },

        calculateCritMultiplier: function(person) {
            var random = Math.floor(Math.random() * 100) + 1;

            if (person == 'hero') {
                critChance = game.heroCritChance;
            } else if (person == 'monster') {
                critChance = game.monsterCritChance;
            }

            return random <= critChance ? 2 : 1;
        },

        calculateMonsterHP: function(heroDamage) {
            game.monsterHP -= heroDamage;

            if (game.monsterHP < 0)
                game.monsterHP = 0;
        },

        calculateHeroHP: function(monsterDamage) {
            game.heroHP -= monsterDamage;

            if (game.heroHP < 0)
                game.heroHP = 0;
        },

        handleFlee: function() {
            game.printToConsole('Oh c\'mon. REALLY?');
        },
    }

    game.init();
</script>


</body>
</html>
